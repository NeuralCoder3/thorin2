# must be registered before `add_thorin_dialect` calls
add_custom_target(thorin_all_dialects)

add_thorin_dialect(affine
    SOURCES
        affine/affine.cpp
        affine/affine.h
        affine/passes/lower_for.cpp
        affine/passes/lower_for.h
    DEPENDS
        mem
        core
    INSTALL
)

add_thorin_dialect(ad_func
    SOURCES
        ad_func/autodiff.cpp
        ad_func/autodiff.h
        ad_func/passes/autodiff_eval.cpp
        ad_func/passes/autodiff_eval.h
        ad_func/passes/autodiff_zero.cpp
        ad_func/passes/autodiff_zero.h
        ad_func/passes/autodiff_zero_cleanup.cpp
        ad_func/passes/autodiff_zero_cleanup.h
        ad_func/auxiliary/autodiff_aux.cpp
        ad_func/auxiliary/autodiff_aux.h
        ad_func/auxiliary/autodiff_rewrite_inner.cpp
        ad_func/auxiliary/autodiff_rewrite_toplevel.cpp
        ad_func/auxiliary/mem/autodiff_mem_aux.cpp
        ad_func/auxiliary/mem/autodiff_mem_aux.h
        ad_func/auxiliary/mem/autodiff_mem_axioms.cpp
        ad_func/auxiliary/mem/autodiff_mem.cpp
        ad_func/normalizers.cpp
        affine/passes/lower_for.cpp
        compile/passes/internal_cleanup.cpp
        compile/passes/internal_cleanup.h
    DEPENDS
        mem
        core
        clos
        compile
        affine
        direct
        matrix
    HEADER_DEPENDS
        mem
    INSTALL
)

add_thorin_dialect(ad_imp
    SOURCES
        ad_imp/autodiff.cpp
        ad_imp/autodiff.h
        ad_imp/passes/autodiff_reduce.cpp
        ad_imp/passes/autodiff_reduce.h
        ad_imp/passes/def_inliner.cpp
        ad_imp/passes/def_inliner.h
        ad_imp/passes/autodiff_eval.cpp
        ad_imp/passes/autodiff_eval.h
        ad_imp/passes/autodiff_rewrite_inner.cpp
        ad_imp/passes/autodiff_rewrite_toplevel.cpp
        ad_imp/analysis/ptr_analysis.cpp
        ad_imp/analysis/war_analysis.cpp
        ad_imp/analysis/gradient_analysis.cpp
        ad_imp/analysis/cache_analysis.cpp
        ad_imp/analysis/alias_analysis.cpp
        ad_imp/analysis/live_analysis.cpp
        ad_imp/analysis/affine_cfa.cpp
        ad_imp/analysis/affine_dfa.cpp
        ad_imp/analysis/analysis.cpp
        ad_imp/analysis/utils.cpp
        ad_imp/analysis/cache_optimizer.cpp
        ad_imp/utils/builder.h
        ad_imp/utils/helper.cpp
        ad_imp/utils/helper.h
        ad_imp/normalizers.cpp
    DEPENDS
        mem
        core
        clos
        affine
        direct
    HEADER_DEPENDS
        mem
    INSTALL
)

add_thorin_dialect(autodiff
    SOURCES
        autodiff/autodiff.cpp
        autodiff/autodiff.h
        autodiff/normalizers.cpp
    DEPENDS
        ad_func
    HEADER_DEPENDS
        ad_func
    INSTALL
)

add_thorin_dialect(clos
    SOURCES
        clos/clos.cpp
        clos/clos.h
        clos/normalizers.cpp
        clos/pass/fp/lower_typed_clos_prep.cpp
        clos/pass/fp/lower_typed_clos_prep.h
        clos/pass/rw/branch_clos_elim.cpp
        clos/pass/rw/branch_clos_elim.h
        clos/pass/rw/clos2sjlj.cpp
        clos/pass/rw/clos2sjlj.h
        clos/pass/rw/clos_conv_prep.cpp
        clos/pass/rw/clos_conv_prep.h
        clos/pass/rw/phase_wrapper.h
        clos/phase/clos_conv.cpp
        clos/phase/clos_conv.h
        clos/phase/lower_typed_clos.cpp
        clos/phase/lower_typed_clos.h
        mem/passes/fp/copy_prop.cpp
        mem/passes/rw/reshape.cpp
        mem/phases/rw/add_mem.cpp
    DEPENDS
        mem
        affine
    HEADER_DEPENDS
        core
    INSTALL
)

add_thorin_dialect(compile
    SOURCES
        compile/compile.cpp
        compile/compile.h
        compile/normalizers.cpp
        compile/passes/debug_print.cpp
        compile/passes/debug_print.h
        compile/passes/internal_cleanup.cpp
        compile/passes/internal_cleanup.h
    INSTALL
)

add_thorin_dialect(core
    SOURCES
        core/core.cpp
        core/core.h
        core/normalizers.cpp
        core/be/ll/ll.cpp
        core/be/ll/ll.h
    DEPENDS
        math
        mem
    INSTALL
)

# add_thorin_dialect(demo
#     SOURCES
#         demo/demo.cpp
#         demo/demo.h
#         demo/normalizers.cpp
#     DEPENDS
#         compile
#     INSTALL
# )

add_thorin_dialect(direct
    SOURCES
        direct/direct.cpp
        direct/direct.h
        direct/passes/ds2cps.cpp
        direct/passes/ds2cps.h
        direct/passes/cps2ds.cpp
        direct/passes/cps2ds.h
        direct/normalizers.cpp
    DEPENDS
        compile
    INSTALL
)

add_thorin_dialect(math
    SOURCES
        math/math.cpp
        math/math.h
        math/normalizers.cpp
        math/passes/lower_math.cpp
    DEPENDS
        compile
    INSTALL
)

add_thorin_dialect(matrix
    SOURCES
        matrix/matrix.cpp
        matrix/matrix.h
        matrix/normalizers.cpp
        matrix/passes/lower_matrix_highlevel.cpp
        matrix/passes/lower_matrix_highlevel.h
        matrix/passes/lower_matrix_mediumlevel.cpp
        matrix/passes/lower_matrix_mediumlevel.h
        matrix/passes/lower_matrix_lowlevel.cpp
        matrix/passes/lower_matrix_lowlevel.h
        compile/passes/internal_cleanup.cpp
    DEPENDS
        refly
        direct
        affine
        core
        mem
        compile
    INSTALL
)

add_thorin_dialect(mem
    SOURCES
        mem/mem.cpp
        mem/mem.h
        mem/normalizers.cpp
        mem/passes/fp/copy_prop.cpp
        mem/passes/fp/copy_prop.h
        mem/passes/fp/ssa_constr.cpp
        mem/passes/fp/ssa_constr.h
        mem/passes/rw/alloc2malloc.cpp
        mem/passes/rw/alloc2malloc.h
        mem/passes/rw/remem_elim.cpp
        mem/passes/rw/remem_elim.h
        mem/passes/rw/reshape.cpp
        mem/passes/rw/reshape.h
        mem/passes/rw/mem_optimize.cpp
        mem/passes/rw/mem_optimize.h
        mem/passes/rw/pack2memset.cpp
        mem/passes/rw/pack2memset.h
        mem/phases/rw/add_mem.cpp
        mem/phases/rw/add_mem.h
    DEPENDS
        compile
    HEADER_DEPENDS
        core
    INSTALL
)

add_thorin_dialect(opt
    SOURCES
        opt/opt.cpp
        opt/opt.h
        opt/normalizers.cpp
    DEPENDS
        compile
        mem
        core
    INSTALL
)

add_thorin_dialect(refly
    SOURCES
        refly/refly.h
        refly/refly.cpp
        refly/passes/remove_perm.h
        refly/passes/remove_perm.cpp
        refly/passes/debug_dump.h
        refly/normalizers.cpp
    DEPENDS
        compile
    INSTALL
)
